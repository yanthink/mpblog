<!--pages/article/reply-details.wxml-->
<wxs src="./../utils.wxs" module="utils" />

<view class="page">
  <view class="page__bd page__body">
    <view class="content-box">
      <scroll-view style="height: 100%" scroll-y scroll-with-animation enable-back-to-top bindscrolltolower="fetchReply" scroll-into-view="{{anchorPoint}}">
        <!-- è¯„è®ºè¯¦æƒ…å¼€å§‹ -->
        <view class="comment-box" id="comment-box">
          <view class="comment-item">
            <view class="comment__avatar-box">
              <image class="avatar" src="{{comment.user.user_info.avatarUrl}}" />
            </view>
            <view class="comment__content-box">
              <view class="comment__content__head">
                <view class="comment__content__head-name">{{comment.user.name}}</view>
              </view>
              <view class="comment__content__body">
                <view class="comment__content">
                  {{comment.content}}
                </view>
                <!-- target å¼€å§‹ -->
                <view wx:if="{{comment.target}}" class="comment__target">
                  <block wx:if="{{comment.target_type === 'App\\Models\\Article'}}">
                    <navigator url="details?id={{comment.target_id}}">
                      <view wx:if="{{comment.target.thumb_list.length > 0}}" class="comment__target-thumb">
                        <image src="{{comment.target.thumb_list[0]}}" />
                      </view>
                      <view wx:else class="comment__target-thumb-default">
                        <image src="/images/icon/article.png" />
                      </view>
                      <view class="comment__target-title">{{comment.target.title}}</view>
                    </navigator>
                  </block>
                </view>
                <!-- target ç»“æŸ -->
              </view>
              <view class="comment__content__footer">
                <view class="comment__time">
                  {{utils.showTime(comment.created_at, 5)}}
                </view>
              </view>
              <view class="comment__content__mate">
                <navigator wx:if="{{comment.like_count > 0}}" url="like-list?id={{comment.id}}&target=comment" class="comment__content__mate-perview">
                  <!-- 
                  <block wx:for="{{comment.likes}}" wx:for-index="idx" wx:key="id" wx:for-item="like">
                    <image class="avatar" src="{{like.user.user_info.avatarUrl}}" />
                  </block>
                   -->
                  <view class="comment__content__mate-perview-info" style="margin: 0">
                    {{comment.like_count}}äººèµè¿‡ >
                  </view>
                </navigator>
                <view wx:else class="comment__content__mate-perview-info" style="margin: 0">
                  æš‚æ— äººèµè¿‡
                </view>
                <view class="comment__content__mate-like" data-comment-id="{{comment.id}}" bindtap="tapLikeByComment">
                  {{comment.like_count}}
                  <image src="/images/icon/{{comment.likes && comment.likes.length > 0 ? 'like_active' : 'like'}}.png" />
                </view>
              </view>
            </view>
          </view>
        </view>
        <!-- è¯„è®ºè¯¦æƒ…ç»“æŸ -->

        <!-- æºå¸¦å›å¤æ•°æ® -->
        <view wx:if="{{comment.replys && comment.replys.length > 0}}" class="with-reply-box">
          <view class="comment-item" wx:for="{{comment.replys}}" wx:for-index="idx" wx:key="id" wx:for-item="reply" data-reply="{{reply}}">
            <view class="comment__avatar-box">
              <image class="avatar" src="{{reply.user.user_info.avatarUrl}}" />
            </view>
            <view class="comment__content-box">
              <view class="comment__content__head">
                <view class="comment__content__head-name">{{reply.user.name}}</view>
                <view class="comment__content__head-like" data-reply-id="{{reply.id}}" catchtap="tapLikeByReply">
                  {{reply.like_count}}
                  <image src="/images/icon/{{reply.likes && reply.likes.length > 0 ? 'like_active' : 'like'}}.png" />
                </view>
              </view>
              <view class="comment__content__body">
                <view class="comment__content">
                  {{reply.content}}
                  <view class="comment__content-parent" wx:if="{{reply.parent}}">
                    //
                    <navigator>@{{reply.parent.user.name}}</navigator>ï¼š{{reply.parent.content}}
                  </view>
                </view>
              </view>
              <view class="comment__content__footer">
                <view class="comment__content__footer__time">
                  {{utils.showTime(reply.created_at, 5)}}
                </view>
                <view class="dot" />
                <view class="comment__content__footer__reply">
                  å›å¤
                </view>
              </view>
            </view>
          </view>
        </view>
        <!-- æºå¸¦å›å¤æ•°æ® -->

        <!-- å›å¤è¯¦æƒ…å¼€å§‹ -->
        <view class="reply-box" id="reply-box">
          <view class="reply-title">å…¨éƒ¨è¯„è®ºï¼ˆ{{comment.reply_count}}ï¼‰</view>
          <view class="comment-item" wx:for="{{replys}}" wx:for-index="idx" wx:key="id" wx:for-item="reply" data-reply="{{reply}}" bindtap="onTapReply">
            <view class="comment__avatar-box">
              <image class="avatar" src="{{reply.user.user_info.avatarUrl}}" />
            </view>
            <view class="comment__content-box">
              <view class="comment__content__head">
                <view class="comment__content__head-name">{{reply.user.name}}</view>
                <view class="comment__content__head-like" data-reply-id="{{reply.id}}" catchtap="tapLikeByReply">
                  {{reply.like_count}}
                  <image src="/images/icon/{{reply.likes && reply.likes.length > 0 ? 'like_active' : 'like'}}.png" />
                </view>
              </view>
              <view class="comment__content__body">
                <view class="comment__content">
                  {{reply.content}}
                  <view class="comment__content-parent" wx:if="{{reply.parent}}">
                    //
                    <navigator>@{{reply.parent.user.name}}</navigator>ï¼š{{reply.parent.content}}
                  </view>
                </view>
              </view>
              <view class="comment__content__footer">
                <view class="comment__content__footer__time">
                  {{utils.showTime(reply.created_at, 5)}}
                </view>
                <view class="dot" />
                <view class="comment__content__footer__reply">
                  å›å¤
                </view>
              </view>
            </view>
          </view>
        </view>
        <!-- å›å¤è¯¦æƒ…ç»“æŸ -->

        <!-- åŠ è½½çŠ¶æ€å¼€å§‹ -->
        <view class="page__bd weui-loadmore__box">
          <view wx:if="{{replyLoading}}" class="weui-loadmore" style="padding-bottom: 1.5em">
            <view class="weui-loading"></view>
            <view class="weui-loadmore__tips">æ­£åœ¨åŠ è½½...</view>
          </view>
        </view>
        <!-- åŠ è½½çŠ¶æ€ç»“æŸ -->

        <view wx:if="{{noMoreReply}}" class="weui-loadmore__box">
          <view class="weui-loadmore weui-loadmore_line">
            <view class="weui-loadmore__tips weui-loadmore__tips_in-line">å·²æ˜¾ç¤ºå…¨éƒ¨è¯„è®º</view>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- å›å¤è¡¨å•å¼€å§‹ -->
    <view wx:if="{{authSetting['scope.userInfo']}}" class="comment__form">
      <textarea class="comment__textarea {{systemInfo.platform}}__textarea" placeholder="{{ commentByReply ? 'å›å¤ ' + commentByReply.user.name: 'å†™è¯„è®º...' }}" value="{{commentContent}}" auto-height show-confirm-bar="{{false}}" cursor-spacing="{{16}}" focus="{{commentFocus}}"
        bindfocus="onCommentFocus" bindblur="onCommentBlur" bindinput="onCommentContentChange" bindconfirm="sendReply" />
      <view class="comment__form__action-box">
        <view hidden="{{commentFocus}}" class="weui-cell__hd comment__form__icon" data-comment-id="{{comment.id}}" bindtap="tapLikeByComment">
          <image src="/images/icon/{{comment.likes && comment.likes.length > 0 ? 'like_active' : 'like'}}.png" />
        </view>
        <view hidden="{{!commentFocus}}" class="publish {{commentContent.length > 0 ? '' : 'disable'}}" bindtap="sendReply">å‘å¸ƒ</view>
      </view>
    </view>
    <!-- å›å¤è¡¨å•ç»“æŸ -->
    <view wx:else>
      <button class="getUserInfo-btn" open-type="getUserInfo" bindgetuserinfo="onGetUserInfo">
        ç‚¹å‡»æ­¤å¤„æˆæƒï¼Œå³å¯è¯„è®ºæ–‡ç« ğŸ˜†
      </button>
    </view>
  </view>
</view>