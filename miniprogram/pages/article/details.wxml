<!--pages/article/details.wxml-->
<wxs src="./../utils.wxs" module="utils" />

<view class="page">
  <view class="page__bd page__body">
    <view class="content-box">
      <scroll-view style="height: 100%" scroll-y scroll-with-animation enable-back-to-top bindscrolltolower="fetchComment" scroll-into-view="{{anchorPoint}}">
        <view class="article-box" id="article-box">
          <!-- æ–‡ç« å¤´éƒ¨å¼€å§‹ -->
          <view class="weui-article__head article__head-box">
            <view class="weui-article__h1">{{article.title}}</view>
            <view class="weui-article__info">
              <view class="weui-article__info__meta">
                {{utils.formatReadCount(article.current_read_count)}} é˜…è¯»
              </view>
              <view class="weui-article__info__meta">0 è¯„è®º</view>
              <view class="weui-article__info__meta weui-media-box__info__meta_extra">
                {{utils.showTime(article.created_at)}}
              </view>
            </view>
          </view>
          <!-- æ–‡ç« å¤´éƒ¨ç»“æŸ -->

          <!-- æ–‡ç« å†…å®¹å¼€å§‹ -->
          <view class="weui-article__section article__content-box">
            <htmltowxml text="{{article.content}}" type="markdown" highlight highlightStyle="darcula" highlightLanguages="{{highlightLanguages}}" bindWxmlTagATap="wxmlTagATap" />

            <view style="text-align: center; margin-top: 60rpx">
              <button class="weui-btn like-btn" bindtap="tapLikeByArticle" type="default">
                {{article.like_count}}
                <image src="/images/icon/{{article.likes && article.likes.length > 0 ? 'like_active' : 'like'}}.png" />
              </button>
            </view>
          </view>
          <!-- æ–‡ç« å†…å®¹ç»“æŸ -->

          <!-- è¯„è®ºå†…å®¹å¼€å§‹ -->
          <view class="comment-box" id="comment-box">
            <view class="comment-title">å…¨éƒ¨è¯„è®ºï¼ˆ{{article.comment_count}}ï¼‰</view>
            <navigator class="comment-item" id="comment" url="comment-details?id={{comment.id}}" wx:for="{{comments}}" wx:for-index="idx" wx:key="id" wx:for-item="comment">
              <view class="comment__avatar-box">
                <image class="avatar" src="{{comment.user.user_info.avatarUrl}}" />
              </view>
              <view class="comment__content-box">
                <view class="comment__content__head">
                  <view class="comment__content__head-name">{{comment.user.name}}</view>
                  <view class="comment__content__head-like" data-comment-id="{{comment.id}}" catchtap="tapLikeByComment">
                    {{comment.like_count}}
                    <image src="/images/icon/{{comment.likes && comment.likes.length > 0 ? 'like_active' : 'like'}}.png" />
                  </view>
                </view>
                <view class="comment__content__body">
                  <view class="comment__content">
                    {{comment.content}}
                  </view>
                </view>
                <view class="comment__content__footer">
                  <view class="comment__content__footer__time">
                    {{utils.showTime(comment.created_at, 5)}}
                  </view>
                  <view class="dot" />
                  <view class="comment__content__footer__reply {{comment.reply_count ? 'has-reply' : ''}}">
                    {{comment.reply_count || '' }}å›å¤
                  </view>
                </view>
              </view>
            </navigator>
          </view>
          <!-- è¯„è®ºå†…å®¹ç»“æŸ -->
        </view>

        <!-- åŠ è½½çŠ¶æ€å¼€å§‹ -->
        <view class="page__bd weui-loadmore__box">
          <view wx:if="{{commentLoading}}" class="weui-loadmore" style="padding-bottom: 1.5em">
            <view class="weui-loading"></view>
            <view class="weui-loadmore__tips">æ­£åœ¨åŠ è½½...</view>
          </view>
        </view>
        <!-- åŠ è½½çŠ¶æ€ç»“æŸ -->

        <view wx:if="{{noMoreComment}}" class="weui-loadmore__box">
          <view class="weui-loadmore weui-loadmore_line">
            <view class="weui-loadmore__tips weui-loadmore__tips_in-line">å·²æ˜¾ç¤ºå…¨éƒ¨è¯„è®º</view>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- è¯„è®ºè¡¨å•å¼€å§‹ -->
    <view wx:if="{{authSetting['scope.userInfo']}}" class="comment__form">
      <textarea class="comment__textarea" placeholder="å†™è¯„è®º..." value="{{commentContent}}" auto-height focus="{{commentFocus}}" bindfocus="onCommentFocus" bindblur="onCommentBlur" bindinput="onCommentContentChange" bindconfirm="sendComment" />
      <view class="comment__form__action-box">
        <view hidden="{{commentFocus}}">
          <!-- è¯„è®º -->
          <view class="weui-cell__hd comment__form__icon" bindtap="scrollToComment">
            <image src="/images/icon/comment.png" />
            <view wx:if="{{article.comment_count > 0}}" class="weui-badge">{{article.comment_count}}</view>
          </view>
          <!-- æ”¶è— -->
          <view class="weui-cell__hd comment__form__icon">
            <image src="/images/icon/favorite.png" />
          </view>
          <!-- ç‚¹èµ -->
          <view class="weui-cell__hd comment__form__icon" bindtap="tapLikeByArticle">
            <image src="/images/icon/{{article.likes && article.likes.length > 0 ? 'like_active' : 'like'}}.png" />
          </view>
        </view>
        <!-- å‘å¸ƒ -->
        <view hidden="{{!commentFocus}}" class="publish {{commentContent.length > 0 ? '' : 'disable'}}" bindtap="sendComment">å‘å¸ƒ</view>
      </view>
    </view>
    <!-- è¯„è®ºè¡¨å•ç»“æŸ -->
    <view wx:else>
      <button class="getUserInfo-btn" open-type="getUserInfo" bindgetuserinfo="onGetUserInfo">
        ç‚¹å‡»æ­¤å¤„æˆæƒï¼Œå³å¯è¯„è®ºæ–‡ç« ğŸ˜†
      </button>
    </view>
  </view>
</view>